<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ロト6 AI予想ラボ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 12px;
      text-align: center;
    }
    .tabs {
      display: flex;
      margin-bottom: 12px;
      border-radius: 999px;
      background: #e0e0e0;
      padding: 4px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
    }
    .tab.active {
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      font-weight: 600;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 12px;
    }
    .field {
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    label {
      display: block;
      margin-bottom: 4px;
    }
    input[type="number"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      margin-right: 4px;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 4px;
      cursor: pointer;
      background: #007aff;
      color: #ffffff;
    }
    button.secondary {
      background: #555555;
      margin-top: 8px;
    }
    textarea {
      width: 100%;
      min-height: 140px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      box-sizing: border-box;
      resize: vertical;
    }
    .note {
      font-size: 0.75rem;
      color: #666;
      line-height: 1.5;
    }
    .hidden {
      display: none;
    }
    .summary-box {
      font-size: 0.8rem;
      background: #f7f7f7;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
    }
    /* ホームメニュー風 */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    .menu-item {
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(135deg, #fff, #f4f7ff);
      border: 1px solid #e0e4ff;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .menu-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    .menu-desc {
      color: #666;
      font-size: 0.75rem;
      line-height: 1.4;
    }
    /* バックナンバー風テーブル */
    .history-table-wrap {
      margin-top: 10px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    table.history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    table.history-table th,
    table.history-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
    }
    table.history-table th {
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    table.history-table tr:nth-child(even) td {
      background: #fcfcfc;
    }
    .ball {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #ddd;
      text-align: center;
      line-height: 24px;
      margin-right: 3px;
      margin-bottom: 2px;
      font-size: 0.75rem;
      background: #fdfdfd;
    }
    .ball-bonus {
      background: #e6f7ff;
      border-color: #7fb8f2;
    }
  </style>
</head>
<body>
  <h1>ロト6 AI予想ラボ</h1>

  <div class="tabs">
    <div class="tab active" id="tab-home" onclick="showTab('home')">ホーム</div>
    <div class="tab" id="tab-loto" onclick="showTab('loto')">ロト6予想</div>
    <div class="tab" id="tab-analysis" onclick="showTab('analysis')">過去データ解析</div>
  </div>

  <!-- ホーム -->
  <div id="panel-home" class="card">
    <div class="field">
      <div class="note" style="margin-bottom:8px;">
        ロト6の過去データを元に、出やすい数字などを“AI風”に解析して予想を作るツールです。<br>
        ※当選を保証するものではありません。遊びとしてお使いください。
      </div>
      <div class="menu-grid">
        <div class="menu-item" onclick="showTab('loto')">
          <div class="menu-title">AIおまかせ予想</div>
          <div class="menu-desc">
            これまで貯めたバックナンバーの傾向を使って、出やすい数字を少しだけ重くした
            “AI予想モード”でロト6の組み合わせを自動生成します（本数字6個＋ボーナス候補1個）。
          </div>
        </div>
        <div class="menu-item" onclick="showTab('analysis')">
          <div class="menu-title">① 過去データ入力＆解析</div>
          <div class="menu-desc">
            上の入力欄に新しい回のデータを貼り付けて「追加」すると、<br>
            AI解析＋下のバックナンバー一覧に反映されます。
          </div>
        </div>
        <div class="menu-item" onclick="showTab('analysis')">
          <div class="menu-title">③ バックナンバー一覧を見る</div>
          <div class="menu-desc">
            「過去データ解析」タブの一番下に、これまで追加した回が<br>
            回号つきバックナンバー風テーブルで貯まっていきます。
          </div>
        </div>
        <div class="menu-item" onclick="openRakuten()">
          <div class="menu-title">公式データを確認</div>
          <div class="menu-desc">
            Safariで楽天の「ロト6 過去当せん番号」ページを開きます。
            必要な回だけコピーしてこのアプリに貼り付けてください。
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ロト6予想 -->
  <div id="panel-loto" class="card hidden">
    <div class="field">
      <div>ロト6（1〜43から本数字6個＋ボーナス候補1個）</div>
      <div class="note">
        ※実際の購入では本数字6個だけ選びます。ここでは「おまけのボーナス候補」も1つ出します。
      </div>
    </div>
    <div class="field">
      <label for="loto-count">組み合わせ数（1〜20）</label>
      <input type="number" id="loto-count" min="1" max="20" value="5" />
    </div>
    <div class="field">
      <label>
        <input type="checkbox" id="loto-sort" checked />
        本数字を小さい順に並べる（ボーナス候補は最後に表示）
      </label>
    </div>
    <div class="field">
      <label>
        <input type="checkbox" id="loto-ai-mode" />
        AI予想モードを使う（頻出＋直近重視）
      </label>
      <div class="note">
        AI予想モードでは、蓄積された全バックナンバーを「学習データ」として扱い、各数字の長期的な出現頻度と直近30回前後のトレンドを同時に解析します。人工知能の深層学習をイメージした重み付き確率モデルにより、よく出ている数字や最近になって出現が増えている数字の重みを高め、ランダム抽選にバイアスをかけて本数字6個＋ボーナス候補1個を自動生成します。統計的な傾向を最大限に反映した“AI風予想エンジン”ですが、あくまでも遊び用の解析機能であり、当せんを保証するものではありません。<br>
        過去データが一件も登録されていない場合は、通常の完全ランダム抽選となります。
      </div>
    </div>
    <button onclick="generateLoto()">AIおまかせで予想する</button>
    <button class="secondary" onclick="copyResult('loto-result')">結果をコピー（テキスト）</button>

    <div class="field" style="margin-top:8px;">
      <label>予想結果（テキスト形式：本数字6個＋ボーナス候補）</label>
      <textarea id="loto-result" placeholder="ここにロト6の予想結果が表示されます"></textarea>
    </div>

    <div class="field" style="margin-top:4px;">
      <label>予想結果（アイコン表示）</label>
      <div id="loto-result-icons"></div>
      <div class="note">
        【1口目】の右に並んでいる丸い玉が本数字、
        <span class="ball ball-bonus" style="vertical-align:middle;">07</span> のような水色の玉がボーナス候補です。
      </div>
    </div>

    <div class="field" style="margin-top:4px;">
      <label>AIコメント（なぜこの数字になったかの簡単な説明）</label>
      <textarea id="loto-comment" placeholder="ここに各口の解説が表示されます"></textarea>
    </div>
  </div>

  <!-- 過去データ解析 -->
  <div id="panel-analysis" class="card hidden">
    <div class="field">
      <div style="margin-bottom:6px;">ロト6の過去当せん番号を貼り付けて解析します</div>
      <div class="note">
        ▼対応しているコピペ形式①（1回分が4行）<br>
        回号\t第1969回<br>
        抽せん日\t2025/01/30<br>
        本数字\t3\t7\t12\t13\t35\t38<br>
        ボーナス数字\t(24)<br><br>
        ▼対応しているコピペ形式②（一覧形式）<br>
        回号\t抽せん日\t本数字\tボーナス数字<br>
        第1641回\t2021/11/25\t2\t5\t7\t12\t16\t20\t33<br>
        第1642回\t2021/11/29\t5\t15\t16\t24\t34\t39\t13<br>
        第1643回\t2021/12/02\t10\t11\t12\t15\t16\t40\t33<br>
        第1644回\t2021/12/06\t1\t9\t14\t28\t32\t40\t15<br><br>
        どちらの形式も混ぜて貼り付けOKです。<br>
        ボーナス数字も出現回数に含めてAI予想に使います。
      </div>
    </div>

    <div class="field">
      <label for="history-input">① ロト6過去データ入力欄（新しく追加する分だけ貼る）</label>
      <textarea id="history-input" placeholder="ここに新しく追加する回のデータをコピペしてください"></textarea>
    </div>
    <button onclick="analyzeHistory()">このデータを追加してAI解析する（バックナンバーに貯める）</button>

    <div class="field" style="margin-top:10px;">
      <div class="note">② AI解析結果（これまで貯めた全データで集計）</div>
      <div id="history-summary" class="summary-box"></div>
    </div>

    <div class="field" style="margin-top:10px;">
      <div class="note">③ バックナンバー一覧（回号つき／上：新しい・下：古い）</div>
      <div id="history-table-wrap" class="history-table-wrap hidden">
        <table class="history-table">
          <thead>
            <tr>
              <th style="width:90px;">回号</th>
              <th>本数字（6個）</th>
              <th>ボーナス</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
          </tbody>
        </table>
      </div>
      <div class="note">
        ※ここは「これまで追加したデータの一覧」を見るだけの場所です。<br>
        　新しいデータを貼るときは、上の「①入力欄」に貼ってください。<br>
        　同じ回を二重に貼り付けて「追加」すると、二重カウントされます。
      </div>
    </div>

    <div class="field" style="margin-top:10px;">
      <button class="secondary" onclick="openRakuten()">楽天の過去当せん番号ページを開く</button>
      <div class="note" style="margin-top:4px;">
        <a href="https://takarakuji.rakuten.co.jp/backnumber/loto6_past/" target="_blank" rel="noopener noreferrer">
          https://takarakuji.rakuten.co.jp/backnumber/loto6_past/
        </a>
      </div>
    </div>

    <div class="note" style="margin-top:8px;">
      ※この解析は、「よく出ている数字」「連続数字」「引っ張り数字」<br>
      「奇数偶数比率」「数字の合計」「ブロック別（1〜22／23〜43）」などを<br>
      簡単に集計するAI風ロジックです。実際の当せん確率が上がる保証はありません。
    </div>
  </div>

  <div class="card">
    <div class="note">
      ・このツールはロト6専用です。<br />
      ・あくまで統計的な“遊び”としてご利用ください。買い過ぎにはご注意を。<br />
      ・予想結果は「メモ」アプリやExcelに貼り付けて保存できます。
    </div>
  </div>

  <script>
    // ===== グローバル（累積データ） =====
    const LOCAL_STORAGE_KEY = "loto6AiLabState_v1";

    let lotoHistoryCounts = new Array(44).fill(0); // 1〜43の出現回数（本数字＋ボーナス）
    let lotoHistoryTotal = 0; // 全ての数字の総数（本数字6×回数＋ボーナス）
    // { round: number|null, nums: [6], bonus: number|null, index: number }
    let lotoDraws = [];
    let nextIndex = 0;

    // ----- 保存・読み込み -----
    function saveState() {
      try {
        const state = {
          draws: lotoDraws,
          counts: lotoHistoryCounts,
          total: lotoHistoryTotal,
          nextIndex: nextIndex
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("saveState failed", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!raw) {
          renderHistoryTable();
          updateSummary();
          return;
        }
        const state = JSON.parse(raw);
        if (!state || !Array.isArray(state.draws) || !Array.isArray(state.counts)) {
          renderHistoryTable();
          updateSummary();
          return;
        }

        // draws 復元
        lotoDraws = state.draws
          .filter(d => d && Array.isArray(d.nums))
          .map((d, idx) => ({
            round: (typeof d.round === "number" ? d.round : null),
            nums: d.nums.map(n => parseInt(n, 10)).filter(n => !isNaN(n)),
            bonus: (typeof d.bonus === "number" && !isNaN(d.bonus)) ? d.bonus : null,
            index: (typeof d.index === "number" ? d.index : idx)
          }));

        // counts 復元
        lotoHistoryCounts = new Array(44).fill(0);
        for (let i = 0; i < 44; i++) {
          if (state.counts && typeof state.counts[i] === "number") {
            lotoHistoryCounts[i] = state.counts[i];
          }
        }

        lotoHistoryTotal = (typeof state.total === "number" ? state.total : 0);
        nextIndex = (typeof state.nextIndex === "number" ? state.nextIndex : lotoDraws.length);
      } catch (e) {
        console.error("loadState failed", e);
      }
      renderHistoryTable();
      updateSummary();
    }

    function showTab(name) {
      const homePanel = document.getElementById("panel-home");
      const lotoPanel = document.getElementById("panel-loto");
      const analysisPanel = document.getElementById("panel-analysis");
      const tabHome = document.getElementById("tab-home");
      const tabLoto = document.getElementById("tab-loto");
      const tabAnalysis = document.getElementById("tab-analysis");

      homePanel.classList.add("hidden");
      lotoPanel.classList.add("hidden");
      analysisPanel.classList.add("hidden");
      tabHome.classList.remove("active");
      tabLoto.classList.remove("active");
      tabAnalysis.classList.remove("active");

      if (name === "home") {
        homePanel.classList.remove("hidden");
        tabHome.classList.add("active");
      } else if (name === "loto") {
        lotoPanel.classList.remove("hidden");
        tabLoto.classList.add("active");
      } else {
        analysisPanel.classList.remove("hidden");
        tabAnalysis.classList.add("active");
      }
    }

    // ===== AI用の重み計算（総出現＋直近30回） =====
    function computeAiWeights() {
      const weights = new Array(44).fill(1); // 最低1は持たせる

      // 全期間の出現回数
      for (let n = 1; n <= 43; n++) {
        const total = lotoHistoryCounts[n] || 0;
        weights[n] += total * 0.4;
      }

      // 直近30回の出現カウント
      const recentCounts = new Array(44).fill(0);
      const recentWindow = 30;
      const start = Math.max(0, lotoDraws.length - recentWindow);
      for (let i = start; i < lotoDraws.length; i++) {
        const d = lotoDraws[i];
        if (!d) continue;
        d.nums.forEach(n => {
          if (n >= 1 && n <= 43) recentCounts[n]++;
        });
        if (d.bonus !== null && d.bonus >= 1 && d.bonus <= 43) {
          recentCounts[d.bonus]++;
        }
      }
      for (let n = 1; n <= 43; n++) {
        const r = recentCounts[n] || 0;
        weights[n] += r * 1.2;
      }

      return weights;
    }

    // 頻出TOP10（本数字＋ボーナス）
    function getTopFrequentNumbers(limit = 10) {
      const items = [];
      for (let n = 1; n <= 43; n++) {
        items.push({ num: n, count: lotoHistoryCounts[n] || 0 });
      }
      items.sort((a, b) => b.count - a.count);
      const top = items.filter(x => x.count > 0).slice(0, limit);
      return top.map(x => x.num);
    }

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    // ===== ロト6予想 =====
    function generateLoto() {
      const countInput = document.getElementById("loto-count");
      const sort = document.getElementById("loto-sort").checked;
      const useAI = document.getElementById("loto-ai-mode");
      const resultArea = document.getElementById("loto-result");
      const commentArea = document.getElementById("loto-comment");
      const iconsContainer = document.getElementById("loto-result-icons");

      let count = parseInt(countInput.value, 10);
      if (isNaN(count) || count < 1) count = 1;
      if (count > 20) count = 20;
      countInput.value = count;

      const lines = [];
      const comments = [];
      iconsContainer.innerHTML = "";

      const aiEnabled = (useAI && useAI.checked && lotoHistoryTotal > 0);
      const topNums = getTopFrequentNumbers(10);
      const topSet = {};
      topNums.forEach(n => { topSet[n] = true; });

      const aiWeights = aiEnabled ? computeAiWeights() : null;

      for (let i = 0; i < count; i++) {
        let mainNums;
        if (aiEnabled) {
          mainNums = generateSmartLoto6(aiWeights);
        } else {
          mainNums = generateRandomLoto6();
        }

        // ボーナス候補を決定（本数字とは別の1個）
        let bonus;
        if (aiEnabled) {
          bonus = generateWeightedBonus(aiWeights, mainNums);
        } else {
          bonus = generateRandomBonus(mainNums);
        }

        let displayMain = mainNums.slice();
        if (sort) {
          displayMain.sort(function(a, b) { return a - b; });
        }

        const line = displayMain.map(n => pad2(n)).join(" ") + " (" + pad2(bonus) + ")";
        lines.push(line);

        // AIコメント
        let cmt = "【" + (i + 1) + "口目】";
        if (aiEnabled) {
          const strong = displayMain.filter(n => topSet[n]);
          const sum = displayMain.reduce((a, b) => a + b, 0);
          let odd = 0, even = 0;
          displayMain.forEach(n => { if (n % 2 === 0) even++; else odd++; });

          if (strong.length > 0) {
            cmt += "頻出数字: " + strong.map(n => pad2(n)).join(", ") + " / ";
          } else {
            cmt += "頻出数字は少なめ / ";
          }
          cmt += "合計: " + sum + " / 奇数" + odd + "・偶数" + even + " / ";
          cmt += "全期間＋直近30回の出現回数を重み付けしたAI抽選 / ";
          cmt += "ボーナス候補: " + pad2(bonus);
        } else {
          cmt += "AI解析データを使わず、完全ランダムで生成（ボーナス候補も含む）";
        }
        comments.push(cmt);

        // アイコン表示
        const row = document.createElement("div");
        row.style.marginBottom = "4px";

        const labelNode = document.createTextNode("【" + (i + 1) + "口目】 ");
        row.appendChild(labelNode);

        displayMain.forEach(n => {
          const span = document.createElement("span");
          span.className = "ball";
          span.textContent = pad2(n);
          row.appendChild(span);
        });

        const spanB = document.createElement("span");
        spanB.className = "ball ball-bonus";
        spanB.textContent = pad2(bonus);
        row.appendChild(spanB);

        iconsContainer.appendChild(row);
      }

      resultArea.value = lines.join("\n");
      commentArea.value = comments.join("\n");
    }

    // 条件付きAIロト6生成（本数字6個）
    function generateSmartLoto6(aiWeights) {
      let best = null;
      let bestScore = -1;

      for (let attempt = 0; attempt < 40; attempt++) {
        const nums = generateWeightedLoto6Once(aiWeights);
        const score = evaluateCombination(nums);
        if (best === null || score > bestScore) {
          bestScore = score;
          best = nums;
        }
        if (score >= 1.0) {
          return nums;
        }
      }
      return best || generateWeightedLoto6Once(aiWeights);
    }

    function evaluateCombination(nums) {
      const sum = nums.reduce((a, b) => a + b, 0);
      let odd = 0, even = 0;
      let small = 0, large = 0; // 1〜22 / 23〜43
      nums.forEach(n => {
        if (n % 2 === 0) even++; else odd++;
        if (n <= 22) small++; else large++;
      });

      let score = 0;

      if (sum >= 100 && sum <= 180) score += 0.5;
      else if (sum >= 80 && sum <= 200) score += 0.2;

      const pattern = odd + ":" + even;
      if (pattern === "3:3" || pattern === "2:4" || pattern === "4:2") score += 0.4;
      else score += 0.1;

      const sb = small + ":" + large;
      if (sb === "3:3" || sb === "2:4" || sb === "4:2") score += 0.3;
      else score += 0.1;

      return score;
    }

    function generateRandomLoto6() {
      const nums = [];
      while (nums.length < 6) {
        const n = Math.floor(Math.random() * 43) + 1;
        if (!nums.includes(n)) nums.push(n);
      }
      return nums;
    }

    function generateWeightedLoto6Once(aiWeights) {
      const available = [];
      for (let n = 1; n <= 43; n++) {
        available.push(n);
      }
      const result = [];

      while (result.length < 6 && available.length > 0) {
        let totalWeight = 0;
        const weights = [];
        for (let i = 0; i < available.length; i++) {
          const num = available[i];
          const w = aiWeights[num] || 1;
          weights.push(w);
          totalWeight += w;
        }
        let r = Math.random() * totalWeight;
        let chosenIndex = 0;
        for (let i = 0; i < available.length; i++) {
          r -= weights[i];
          if (r <= 0) {
            chosenIndex = i;
            break;
          }
        }
        const chosenNum = available[chosenIndex];
        result.push(chosenNum);
        available.splice(chosenIndex, 1);
      }
      return result;
    }

    // ボーナス候補（AI重み付き）
    function generateWeightedBonus(aiWeights, usedMain) {
      const used = {};
      usedMain.forEach(n => used[n] = true);

      const candidates = [];
      const weights = [];
      let totalWeight = 0;

      for (let n = 1; n <= 43; n++) {
        if (used[n]) continue;
        const w = aiWeights[n] || 1;
        candidates.push(n);
        weights.push(w);
        totalWeight += w;
      }

      if (candidates.length === 0) {
        return 1;
      }

      let r = Math.random() * totalWeight;
      for (let i = 0; i < candidates.length; i++) {
        r -= weights[i];
        if (r <= 0) {
          return candidates[i];
        }
      }
      return candidates[candidates.length - 1];
    }

    // ボーナス候補（ランダム）
    function generateRandomBonus(usedMain) {
      const used = {};
      usedMain.forEach(n => used[n] = true);
      const candidates = [];
      for (let n = 1; n <= 43; n++) {
        if (!used[n]) candidates.push(n);
      }
      if (candidates.length === 0) return 1;
      const idx = Math.floor(Math.random() * candidates.length);
      return candidates[idx];
    }

    // ===== 過去データ解析（追加＆累積） =====
    function analyzeHistory() {
      const input = document.getElementById("history-input").value;
      const summaryElem = document.getElementById("history-summary");

      if (!input.trim()) {
        summaryElem.textContent = "新しく追加するデータが入力されていません。";
        return;
      }

      const lines = input.split(/\r?\n/);
      let currentRound = null;
      let currentMain = [];
      let currentBonus = null;
      let newDraws = [];
      let foundSomething = false;

      function commitBlock() {
        if (currentMain.length === 6) {
          const numsSorted = currentMain.slice().sort((a, b) => a - b);
          const draw = {
            round: currentRound,
            nums: numsSorted,
            bonus: (currentBonus !== null && !isNaN(currentBonus)) ? currentBonus : null,
            index: nextIndex++
          };
          newDraws.push(draw);

          numsSorted.forEach(n => {
            if (n >= 1 && n <= 43) {
              lotoHistoryCounts[n] = (lotoHistoryCounts[n] || 0) + 1;
              lotoHistoryTotal++;
            }
          });
          if (draw.bonus !== null && draw.bonus >= 1 && draw.bonus <= 43) {
            lotoHistoryCounts[draw.bonus] = (lotoHistoryCounts[draw.bonus] || 0) + 1;
            lotoHistoryTotal++;
          }
        }
        currentRound = null;
        currentMain = [];
        currentBonus = null;
      }

      lines.forEach(rawLine => {
        const line = rawLine.trim();
        if (!line) return;

        const norm = line
          .replace(/\t/g, " ")
          .replace(/　/g, " ");

        if (/^回号\s+抽せん日\s+本数字/i.test(norm)) {
          if (currentMain.length > 0) {
            commitBlock();
          }
          return;
        }

        if (/第\s*\d+\s*回/.test(norm) && !/^回号/.test(norm) && !/^本数字/.test(norm) && !/^ボーナス数字/.test(norm)) {
          foundSomething = true;
          if (currentMain.length > 0) {
            commitBlock();
          }
          let roundNo = null;
          const rm = norm.match(/第\s*(\d+)\s*回/);
          if (rm) {
            roundNo = parseInt(rm[1], 10);
          }
          const parts = norm.split(/\s+/);
          const numsAll = [];
          parts.forEach(p => {
            const n = parseInt(p, 10);
            if (!isNaN(n) && n >= 1 && n <= 43) {
              numsAll.push(n);
            }
          });
          if (numsAll.length >= 7) {
            const bonus = numsAll[numsAll.length - 1];
            const mains = numsAll.slice(numsAll.length - 7, numsAll.length - 1);
            if (mains.length === 6) {
              const numsSorted = mains.slice().sort((a, b) => a - b);
              const draw = {
                round: roundNo,
                nums: numsSorted,
                bonus: bonus,
                index: nextIndex++
              };
              newDraws.push(draw);

              numsSorted.forEach(n => {
                if (n >= 1 && n <= 43) {
                  lotoHistoryCounts[n] = (lotoHistoryCounts[n] || 0) + 1;
                  lotoHistoryTotal++;
                }
              });
              if (bonus >= 1 && bonus <= 43) {
                lotoHistoryCounts[bonus] = (lotoHistoryCounts[bonus] || 0) + 1;
                lotoHistoryTotal++;
              }
            }
          }
          return;
        }

        if (norm.startsWith("回号")) {
          if (currentMain.length > 0) {
            commitBlock();
          }
          foundSomething = true;
          currentRound = null;
          const m = norm.match(/(\d+)/);
          if (m) {
            currentRound = parseInt(m[1], 10);
          }
          return;
        }

        if (norm.startsWith("本数字")) {
          foundSomething = true;
          currentMain = [];
          const parts = norm.split(/\s+/).slice(1);
          parts.forEach(p => {
            const n = parseInt(p, 10);
            if (!isNaN(n) && n >= 1 && n <= 43 && currentMain.length < 6) {
              currentMain.push(n);
            }
          });
          return;
        }

        if (norm.startsWith("ボーナス数字")) {
          foundSomething = true;
          const m = norm.replace(/[()（）]/g, " ").match(/(\d+)/);
          if (m) {
            currentBonus = parseInt(m[1], 10);
          }
          return;
        }
      });

      if (currentMain.length > 0) {
        commitBlock();
      }

      if (!foundSomething || newDraws.length === 0) {
        summaryElem.textContent = "対応形式として認識できるデータがありませんでした。入力形式を確認してください。";
        return;
      }

      newDraws.forEach(draw => lotoDraws.push(draw));

      document.getElementById("history-input").value = "";

      renderHistoryTable();
      updateSummary();
      saveState(); // ★ ここで毎回保存
    }

    function renderHistoryTable() {
      const tbody = document.getElementById("history-table-body");
      const wrap = document.getElementById("history-table-wrap");

      tbody.innerHTML = "";
      if (lotoDraws.length === 0) {
        wrap.classList.add("hidden");
        return;
      }

      const sorted = lotoDraws.slice().sort((a, b) => {
        if (a.round !== null && b.round !== null && a.round !== b.round) {
          return b.round - a.round;
        }
        return b.index - a.index;
      });

      sorted.forEach(draw => {
        const tr = document.createElement("tr");

        const tdRound = document.createElement("td");
        if (draw.round !== null && !isNaN(draw.round)) {
          tdRound.textContent = "第" + draw.round + "回";
        } else {
          tdRound.textContent = "No." + (draw.index + 1);
        }
        tr.appendChild(tdRound);

        const tdNums = document.createElement("td");
        draw.nums.forEach(n => {
          const span = document.createElement("span");
          span.className = "ball";
          span.textContent = pad2(n);
          tdNums.appendChild(span);
        });
        tr.appendChild(tdNums);

        const tdBonus = document.createElement("td");
        if (draw.bonus !== null && !isNaN(draw.bonus)) {
          const spanB = document.createElement("span");
          spanB.className = "ball ball-bonus";
          spanB.textContent = pad2(draw.bonus);
          tdBonus.appendChild(spanB);
        } else {
          tdBonus.textContent = "-";
        }
        tr.appendChild(tdBonus);

        tbody.appendChild(tr);
      });

      wrap.classList.remove("hidden");
    }

    function updateSummary() {
      const summaryElem = document.getElementById("history-summary");

      const items = [];
      for (let n = 1; n <= 43; n++) {
        items.push({ num: n, count: lotoHistoryCounts[n] || 0 });
      }
      items.sort((a, b) => b.count - a.count);
      const top = items.slice(0, 10);
      const bottom = items.slice(-10).filter(x => x.count > 0);
      const never = items.filter(x => x.count === 0).map(x => x.num);

      let drawsWithConsecutive = 0;
      const consecutivePairCounts = {};
      let drawsWithPull = 0;
      const pullCounts = {};

      let oddTotal = 0;
      let evenTotal = 0;
      const sumRanges = { low: 0, mid: 0, high: 0, veryhigh: 0 };
      const blockCounts = { b1: 0, b2: 0, b3: 0, b4: 0 };

      for (let i = 0; i < lotoDraws.length; i++) {
        const nums = lotoDraws[i].nums;
        let s = 0;
        let hasConsecutive = false;

        for (let j = 0; j < nums.length; j++) {
          const n = nums[j];
          s += n;
          if (n % 2 === 0) evenTotal++; else oddTotal++;
          if (n >= 1 && n <= 10) blockCounts.b1++;
          else if (n >= 11 && n <= 22) blockCounts.b2++;
          else if (n >= 23 && n <= 33) blockCounts.b3++;
          else blockCounts.b4++;
        }

        for (let j = 0; j < nums.length - 1; j++) {
          if (nums[j + 1] === nums[j] + 1) {
            hasConsecutive = true;
            const key = nums[j] + "-" + nums[j + 1];
            consecutivePairCounts[key] = (consecutivePairCounts[key] || 0) + 1;
          }
        }
        if (hasConsecutive) drawsWithConsecutive++;

        if (s <= 120) sumRanges.low++;
        else if (s <= 180) sumRanges.mid++;
        else if (s <= 240) sumRanges.high++;
        else sumRanges.veryhigh++;

        if (i > 0) {
          const prev = lotoDraws[i - 1].nums;
          const prevSet = {};
          prev.forEach(n => prevSet[n] = true);
          let hasPull = false;
          nums.forEach(n => {
            if (prevSet[n]) {
              hasPull = true;
              pullCounts[n] = (pullCounts[n] || 0) + 1;
            }
          });
          if (hasPull) drawsWithPull++;
        }
      }

      const consecutiveItems = Object.keys(consecutivePairCounts).map(key => ({
        pair: key,
        count: consecutivePairCounts[key]
      })).sort((a, b) => b.count - a.count).slice(0, 5);

      const pullItems = Object.keys(pullCounts).map(num => ({
        num: parseInt(num, 10),
        count: pullCounts[num]
      })).sort((a, b) => b.count - a.count).slice(0, 5);

      const totalDraws = lotoDraws.length;
      const totalNumsMain = totalDraws * 6;
      let text = "";

      text += "◆解析サマリー（これまで追加した全データ）\n";
      text += "対象回数: " + totalDraws + " 回\n";
      text += "出現カウント対象: 本数字 + ボーナス数字（AI予想の重み付け）\n";

      text += "\n▼出現回数 上位10数字（よく出ている：本数字＋ボーナス）\n";
      top.forEach(x => {
        text += pad2(x.num) + " : " + x.count + " 回\n";
      });

      if (bottom.length > 0) {
        text += "\n▼出現回数 下位の数字（あまり出ていないが一応出ている）\n";
        bottom.forEach(x => {
          text += pad2(x.num) + " : " + x.count + " 回\n";
        });
      }

      if (never.length > 0) {
        text += "\n▼一度も出ていない数字（このデータ範囲内）\n";
        const chunks = [];
        for (let i = 0; i < never.length; i += 10) {
          const part = never.slice(i, i + 10).map(n => pad2(n)).join(" ");
          chunks.push(part);
        }
        text += chunks.join("\n") + "\n";
      }

      if (totalDraws > 0) {
        const consecPct = (drawsWithConsecutive * 100 / totalDraws).toFixed(1);
        const pullPct = (drawsWithPull * 100 / totalDraws).toFixed(1);
        text += "\n▼連続数字（n, n+1 が含まれる回）\n";
        text += "連続数字を含む回: " + drawsWithConsecutive + " 回（" + consecPct + "%）\n";
        if (consecutiveItems.length > 0) {
          text += "よく出る連続ペア 上位:\n";
          consecutiveItems.forEach(item => {
            text += " " + item.pair + " : " + item.count + " 回\n";
          });
        }

        text += "\n▼引っ張り数字（前回から続けて出た数字：本数字のみ）\n";
        text += "引っ張り数字を含む回: " + drawsWithPull + " 回（" + pullPct + "%）\n";
        if (pullItems.length > 0) {
          text += "よく引っ張られている数字 上位:\n";
          pullItems.forEach(item => {
            text += " " + pad2(item.num) + " : " + item.count + " 回\n";
          });
        }

        const oddPct = (oddTotal * 100 / totalNumsMain).toFixed(1);
        const evenPct = (evenTotal * 100 / totalNumsMain).toFixed(1);
        text += "\n▼奇数・偶数の比率（本数字6個ベース）\n";
        text += "奇数: " + oddTotal + " 個（" + oddPct + "%）\n";
        text += "偶数: " + evenTotal + " 個（" + evenPct + "%）\n";

        text += "\n▼合計値の傾向（本数字6個の合計）\n";
        text += "60〜120: " + sumRanges.low + " 回\n";
        text += "121〜180: " + sumRanges.mid + " 回\n";
        text += "181〜240: " + sumRanges.high + " 回\n";
        text += "241以上: " + sumRanges.veryhigh + " 回\n";

        text += "\n▼ブロック別の出現（本数字のみ）\n";
        text += "1〜10:  " + blockCounts.b1 + " 個\n";
        text += "11〜22: " + blockCounts.b2 + " 個\n";
        text += "23〜33: " + blockCounts.b3 + " 個\n";
        text += "34〜43: " + blockCounts.b4 + " 個\n";
      }

      text += "\nこの解析結果をもとに、「ロト6予想」タブでAI予想モードをONにすると、\n";
      text += "本数字＋ボーナス数字の出現回数（全期間＋直近30回）が多い数字ほど\n";
      text += "少しだけ選ばれやすくなるように重み付けして抽選します。";

      summaryElem.textContent = text;
    }

    // ===== 共通ユーティリティ =====
    function copyResult(textareaId) {
      const ta = document.getElementById(textareaId);
      ta.select();
      ta.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("結果をコピーしました。メモ等に貼り付けてください。");
    }

    function openRakuten() {
      window.open("https://takarakuji.rakuten.co.jp/backnumber/loto6_past/", "_blank");
    }

    // ページ読み込み時に保存データを復元
    (function () {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadState);
      } else {
        loadState();
      }
    })();
  </script>
</body>
</html>
